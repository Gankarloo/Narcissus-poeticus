name: Test logic
on:
  push:
    branches:
      - '*'
    paths-ignore:
      - '**/README.md'
  workflow_dispatch:

env:
  IMAGE_DESC: "My Customized Universal Blue Image"
  IMAGE_KEYWORDS: "bootc,ublue,universal-blue"
  IMAGE_LOGO_URL: "https://avatars.githubusercontent.com/u/120078124?s=200&v=4"  # Put your own image here for a fancy profile on https://artifacthub.io/!
  IMAGE_NAME: "${{ github.event.repository.name }}"  # output image name, usually same as repo name
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"  # do not edit
  DEFAULT_TAG: "latest"
#   BASE_IMAGE: ghcr.io/ublue-os/bluefin-dx-nvidia-open
#   BASE_TAG: latest  # or whatever tag you're using

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}-${{ inputs.brand_name}}-${{ inputs.stream_name }}
  cancel-in-progress: true

jobs:
  check-base-image:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check if base image was updated
        id: check
        run: |
          # Get Base image
          BASE_IMAGE=$(grep ^FROM Containerfile | tail -1 | awk '{sub(/:.*/, "", $2); print $2}')
          BASE_TAG=$(grep ^FROM Containerfile | tail -1 | awk '{match($2, /:(.*)$/, arr); if (length(arr) > 1) {print arr[1]} else {print "latest"}}')
          
          # Get the digest of the base image
          # BASE_DIGEST=$(skopeo inspect docker://${{ env.BASE_IMAGE }}:${{ env.BASE_TAG }} --format '{{.Digest}}' 2>/dev/null || echo "")
          BASE_DIGEST=$(skopeo inspect docker://${BASE_IMAGE}:${BASE_TAG} --format '{{.Digest}}' 2>/dev/null || echo "")
          
          if [ -z "$BASE_DIGEST" ]; then
            echo "Could not fetch base image digest, building anyway"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Base image digest: $BASE_DIGEST"
          
          # Get our image's base layer digest (stored as label)
          echo skopeo inspect docker://${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format '{{index .Labels "org.opencontainers.image.base.digest"}}'
          OUR_BASE_DIGEST=$(skopeo inspect docker://${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:latest --format '{{index .Labels "org.opencontainers.image.base.digest"}}' 2>/dev/null || echo "")
          
          echo "Our recorded base digest: $OUR_BASE_DIGEST"
          
          if [ -z "$OUR_BASE_DIGEST" ]; then
            echo "No previous base digest found, building"
            echo "should_build=true"
            echo "should_build=true" >> $GITHUB_OUTPUT
          elif [ "$BASE_DIGEST" != "$OUR_BASE_DIGEST" ]; then
            echo "Base image has been updated, building"
            echo "should_build=true"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "Base image unchanged, skipping build"
            echo "should_build=false"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

